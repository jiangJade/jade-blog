---
title: 文件上传如何做断点续传
date: 2020-02-7
tags:
  - js
categories:
  - js
---

## slice

利用 Blob.prototype.slice 方法，和数组的 slice 方法相似，调用的 slice 方法可以返回原文件的某个切片

这样就可以根据预先设置好的切片最大数量将文件切分为一个个切片，然后借助 http 的可并发性，同时上传多个切片，这样从从原本传一个大文件，变成同时传多个小的文件切片，可以大大减少上传时间

另外由于是并发，传输到服务端的顺序可能会发生变化，所以我们还需要给每个切片记录顺序

## 服务端

服务端需要负责接受这些切片，并在接收到所有切片后合并切片
这里又引伸出两个问题

何时合并切片，即切片什么时候传输完成 如何合并切片

第一个问题需要前端进行配合，前端在每个切片中都携带切片最大数量的信息，当服务端接受到这个数量的切片是自动合并，也可以额外发一个请求主动通知服务端进行切片的合并

第二个问题：具体如何合并切片呢？这里可以使用 nodejs 的 api fs.appendFileSync,它可以同步地将数据追加到指定文件，也就是说，当服务端接受素有切片后，先创建一个最终的文件，然后将所有切片逐步合并到这个文件中
